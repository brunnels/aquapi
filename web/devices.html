<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	           "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link href="/lib/jquery-ui-1.10.3.custom/css/aquapi/jquery-ui-1.10.3.custom.css" rel="stylesheet"/>
<link href="aquapy.css" rel="stylesheet"/>
<script src="/lib/jquery-ui-1.10.3.custom/js/jquery-1.9.1.js" type="text/javascript"></script>
<script src="/lib/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.js" type="text/javascript"></script>
<script src="aquapy.js" type="text/javascript"></script>
<meta name="viewport" content="width=450">
<link rel="icon" type="image/png" href="/aquapi-icon.png"/>
<script type="text/javascript">


$(document).ready(function () {

    aquapy = new AquaPy();
    aquapy.Connect("ws://aquapi.rgba.net/socket");

    var accordion = $( "#accordion" );

    function createFieldSet(modeName, deviceName, varInfos) {
        var fieldset = $('<fieldset><legend>' + modeName + '</legend></fieldset>');
	for (i in varInfos) {
	    var varInfo = varInfos[i];
	    var div = $('<div/>').text(varInfo['name'] + ":").appendTo(fieldset);
            var widget = createVarWidget(deviceName, varInfo);
            if (widget) {
	        widget.appendTo(div);
            }
	}
	return fieldset;
    }

    function createDeviceDiv(deviceName, deviceData) {
        var header = $('<h3>' + deviceName + '</h3>').appendTo(accordion);
        var div = $('<div/>').appendTo(accordion);

	var table = $('<table class="varTable"/>').appendTo(div);
		

	var modes = ["input","output","option"];
	var modeNames = ["Inputs","Outputs","Options"];
	for (i in modes) {
	    var varSpecs = [];
            for (variableName in deviceData['variables']) {
		variable = deviceData['variables'][variableName];
		if (variable['mode'] == modes[i]) {
		    varSpecs.push(variable);
		}
	    }
	    if (varSpecs.length) {
		var tr = $('<tr><td class="headerRow" colspan="2">' + modeNames[i] + '</td></tr>').appendTo(table);


		for (var j in varSpecs) {
		    var tr = $('<tr class="varRow"><td class="varTableNameTd">' + varSpecs[j]['name'] + '</td></tr>');
		    var td = $('<td></td>');
		    
		    var widget = createVarWidget(deviceName, varSpecs[j]);
		    td.append(widget);
		    tr.append(td);
		    table.append(tr);
		}
		//createFieldSet(modeNames[i], deviceName, varSpecs).appendTo(div);
	    }
	}
    }

    function loadConfig(config) {
        console.log('Payload: ' + config);

        for (deviceName in config) {
            createDeviceDiv(deviceName, config[deviceName]);
        }
        accordion.accordion();
    }

    function onOpen() {
        aquapy.Bind('config', loadConfig)
	aquapy.Send('getConfig',{})
    }

    aquapy.Bind('open', onOpen);
    
    $('.sidebarButton').button();
});


</script>
</head>
<body>
<img src="/images/aquapi-logo.png" width="300px"/>

<table width="100%">
<tr>
<td class="sidebar">
<button class="sidebarButton">Status</button>
<button class="sidebarButton">Devices</button>
<button class="sidebarButton">Rules</button>

</td><td>
<div id="accordion"/>
</td>
</tr>
</table>

</body>
</html>
