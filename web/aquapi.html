<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	           "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link href="/lib/jquery-ui-1.10.3.custom/css/aquapi/jquery-ui-1.10.3.custom.css" rel="stylesheet"/>
<link href="aquapi.css" rel="stylesheet"/>
<script src="/lib/jquery-ui-1.10.3.custom/js/jquery-1.9.1.js" type="text/javascript"></script>
<script src="/lib/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.js" type="text/javascript"></script>
<script src="aquapi.js" type="text/javascript"></script>
<script src="widget.js" type="text/javascript"></script>
<meta name="viewport" content="width=450">
<link rel="icon" type="image/png" href="/images/aquapi-icon.png"/>
<script type="text/javascript">
"use strict";

function loadDashboard() {
    aquapy.Bind('open', function() {
	loadWidgetState();
    });

    var widgetContainer = $('<div id="widgetContainer"></div>');
    $('.centeredContent').append(widgetContainer);

    var addWidgetButton = $('<div class="addWidgetButton"></div>');
    $('.centeredContent').append(addWidgetButton);

    //var addWidgetButton = $('<button>Add Widget</button>');
    //addWidgetButton.button();
    addWidgetButton.click(showCreateWidgetDialog);
}

function loadDevices() {

    var accordion = $('<div id="accorcian"></div>');
    $('.centeredContent').append(accordion);

    function createFieldSet(modeName, deviceName, varInfos) {
        var fieldset = $('<fieldset><legend>' + modeName + '</legend></fieldset>');
	for (i in varInfos) {
	    var varInfo = varInfos[i];
	    var div = $('<div/>').text(varInfo['name'] + ":").appendTo(fieldset);
            var widget = createVarWidget(deviceName, varInfo);
            if (widget) {
	        widget.appendTo(div);
            }
	}
	return fieldset;
    }

    function createDeviceDiv(deviceName, deviceData) {
        var header = $('<h3>' + deviceName + '</h3>').appendTo(accordion);
        var div = $('<div/>').appendTo(accordion);

	var table = $('<table class="varTable"/>').appendTo(div);

	var modes = ["input","output","option"];
	var modeNames = ["Inputs","Outputs","Options"];
	for (var i in modes) {
	    var varSpecs = [];
            for (var variableName in deviceData['variables']) {
		var variable = deviceData['variables'][variableName];
		if (variable['mode'] == modes[i]) {
		    varSpecs.push(variable);
		}
	    }
	    if (varSpecs.length) {
		var tr = $('<tr><td class="headerRow" colspan="2">' + modeNames[i] + 
			   '</td></tr>').appendTo(table);


		for (var j in varSpecs) {
		    var tr = $('<tr class="varRow"><td class="varTableNameTd">' +
			       varSpecs[j]['name'] + '</td></tr>');
		    var td = $('<td></td>');
		    
		    var widget = createVarWidget(deviceName, varSpecs[j]);
		    td.append(widget);
		    tr.append(td);
		    table.append(tr);
		}
		//createFieldSet(modeNames[i], deviceName, varSpecs).appendTo(div);
	    }
	}
    }

    function loadConfig(config) {
        console.log('Payload: ');
        console.log(config);
	accordion.html('');
        for (var deviceName in config) {
            createDeviceDiv(deviceName, config[deviceName]);
        }
        accordion.accordion({heightStyle: 'content'});
        accordion.accordion('refresh');
    }

    function onOpen() {
	aquapy.Send('getConfig',{})
    }

    function loadDevice(deviceName, device) {
	var variables = device['variables'];
	for (var varName in variables) {
	}
    }

    function onLoaded() {
	var devices = GetDevices();
	for (var deviceName in devices) {
	    loadDevice(deviceName, devices[deviceName])
	}
    }

    aquapy.Bind('config', loadConfig)
    aquapy.Bind('open', onOpen);
}

var aquapy = new AquaPy();

$(document).ready(function () {
    $('.headerItem').click(function(item) {
	var url = item.target.attributes.url.value;
	window.location = url;
    });

    
    aquapy.Connect("ws://" + window.location.hostname + ":" + window.location.port + "/socket");
    
    switch(location.pathname) {
    case '/':
	loadDashboard();
	break;
    case '/devices':
	loadDevices();
	break;
    }
    $("[url='" + location.pathname + "']").addClass('activeHeaderItem');

});

</script>
</head>

<body>

<div class="header">
<table class="headerContent"><tr>
<td><img src="/images/aquapi-logo.png" height="75px" class="headerItem" url="/"/></td>
<td style="width: 100%"></td>
<td class="headerItem" url="/">Dashboard</td>
<td class="headerItem" url="/devices">Devices</td>
<td class="headerItem" url="/rules">Rules</td>
</tr></table>
</div>

<div class="headerSeparator"></div>
<div class="centeredContent"></div>

</body>
</html>
